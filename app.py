import re
import streamlit as st

st.set_page_config(page_title="Explain Like I'm 12", page_icon="üß†", layout="centered")

SUFFIXES = ("—Ü–∏—è", "–∏–∑–º", "–Ω–æ—Å—Ç—å", "–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ª–æ–≥–∏—è", "–º–µ—Ç—Ä–∏—è", "–≥–µ–Ω–µ–∑", "—Ñ—É–Ω–∫—Ü–∏—è", "–ø—Ä–æ—Ü–µ—Å—Å")

SUBJECT_HINTS = {
    "Biology": ["–∫–ª–µ—Ç", "–Ω–µ–π—Ä–æ–Ω", "–≥–µ–Ω", "–±–µ–ª–æ–∫", "–æ—Ä–≥–∞–Ω", "–º–æ–∑–≥", "–∫—Ä–æ–≤", "–∏–º–º—É–Ω"],
    "Chemistry": ["—Ä–µ–∞–∫—Ü", "–º–æ–ª—å", "–∫–∞—Ç–∞–ª–∏–∑", "–∫–∏—Å–ª", "–æ—Å–Ω–æ–≤–∞–Ω", "—Ä–∞—Å—Ç–≤–æ—Ä", "–æ–∫–∏—Å", "–∏–æ–Ω"],
    "Physics": ["—Å–∏–ª–∞", "–¥–∞–≤–ª–µ–Ω", "—Å–∫–æ—Ä–æ—Å—Ç", "—ç–Ω–µ—Ä–≥", "–ø–æ–ª–µ", "–Ω–∞–ø—Ä—è–∂", "–º–∞—Å—Å–∞", "—É—Å–∫–æ—Ä"],
    "History": ["–≤–µ–∫", "–≥–æ—Å—É–¥–∞—Ä", "—Ä–µ–≤–æ–ª—é—Ü", "–∏–º–ø–µ—Ä", "–≤–æ–π–Ω", "—Ä–µ—Ñ–æ—Ä–º", "–∫—É–ª—å—Ç—É—Ä"],
}

def split_sentences(text: str):
    text = re.sub(r"\s+", " ", text).strip()
    if not text:
        return []
    parts = re.split(r"(?<=[.!?])\s+", text)
    return [p.strip() for p in parts if p.strip()]

def detect_subject(text: str):
    t = text.lower()
    best = ("General", 0)
    for subj, keys in SUBJECT_HINTS.items():
        score = sum(1 for k in keys if k in t)
        if score > best[1]:
            best = (subj, score)
    return best[0]

def pick_hard_words(text: str, k=8):
    words = re.findall(r"[A-Za-z–ê-–Ø–∞-—è—ë–Å\-]{4,}", text)
    cand = []
    for w in words:
        wl = w.lower()
        score = 0
        if len(w) >= 11:
            score += 2
        if wl.endswith(SUFFIXES):
            score += 2
        if "—Ü–∏" in wl or "–∏–∑–º" in wl or "–ª–æ–≥" in wl:
            score += 1
        if score > 0:
            cand.append((score, w))
    cand.sort(reverse=True, key=lambda x: (x[0], len(x[1])))
    out, seen = [], set()
    for _, w in cand:
        wl = w.lower()
        if wl not in seen:
            out.append(w)
            seen.add(wl)
        if len(out) >= k:
            break
    return out

def make_glossary(words):
    defs = []
    for w in words:
        wl = w.lower()
        if wl.endswith("—Ü–∏—è"):
            d = "–≠—Ç–æ —Å–ª–æ–≤–æ –ø—Ä–æ –¥–µ–π—Å—Ç–≤–∏–µ/—è–≤–ª–µ–Ω–∏–µ. –ü—Ä–æ—â–µ: ¬´—Ç–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç¬ª."
        elif wl.endswith("–∏–∑–º"):
            d = "–≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–¥–µ–∏/–ø–æ–¥—Ö–æ–¥–∞. –ü—Ä–æ—â–µ: ¬´—Å–ø–æ—Å–æ–± –¥—É–º–∞—Ç—å –∏–ª–∏ –æ–±—ä—è—Å–Ω—è—Ç—å¬ª."
        elif wl.endswith("–Ω–æ—Å—Ç—å"):
            d = "–≠—Ç–æ ¬´–∫–∞—á–µ—Å—Ç–≤–æ/—Å–≤–æ–π—Å—Ç–≤–æ¬ª. –ü—Ä–æ—â–µ: ¬´–Ω–∞—Å–∫–æ–ª—å–∫–æ —á—Ç–æ-—Ç–æ —Ç–∞–∫–æ–µ-—Ç–æ¬ª."
        elif "—Ä–µ–∞–∫" in wl:
            d = "–≠—Ç–æ –∫–æ–≥–¥–∞ –≤–µ—â–µ—Å—Ç–≤–∞ –º–µ–Ω—è—é—Ç—Å—è –∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ."
        elif "—ç–Ω–µ—Ä–≥" in wl:
            d = "–≠—Ç–æ ¬´–∑–∞–ø–∞—Å —Å–∏–ª¬ª: —Ç–æ, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å —Ä–∞–±–æ—Ç—É."
        else:
            d = "–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏: –∫–ª—é—á–µ–≤–æ–π —Ç–µ—Ä–º–∏–Ω –∏–∑ —Ç–µ–∫—Å—Ç–∞."
        defs.append((w, d))
    return defs

def eli12_explain(text: str):
    sents = split_sentences(text)
    if not sents:
        return "", [], [], []

    subject = detect_subject(text)
    hard = pick_hard_words(text, k=8)
    glossary = make_glossary(hard)

    first = sents[0]
    main = re.sub(r"[,;:]\s*", ". ", first).strip()
    if len(main) > 160:
        main = main[:160].rstrip() + "‚Ä¶"

    bullets = []
    for s in sents[:5]:
        x = s
        x = re.sub(r"\b(—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ|–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ)\b", "–ø–æ—ç—Ç–æ–º—É", x, flags=re.I)
        x = re.sub(r"\b(–æ–¥–Ω–∞–∫–æ)\b", "–Ω–æ", x, flags=re.I)
        x = re.sub(r"\b(—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è)\b", "–æ–±—ã—á–Ω–æ –∏–º–µ–µ—Ç", x, flags=re.I)
        x = re.sub(r"\b(–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è)\b", "—ç—Ç–æ", x, flags=re.I)
        x = re.sub(r"\s+", " ", x).strip()
        if len(x) > 140:
            x = x[:140].rstrip() + "‚Ä¶"
        bullets.append(x)

    explanation = (
        f"**Subject:** {subject}\n\n"
        f"**Main idea (simple):** {main}\n\n"
        f"**In simple steps:**\n" + "\n".join([f"- {b}" for b in bullets])
    )

    if subject == "Physics":
        examples = [
            "–õ—ã–∂–∏ –Ω–µ –ø—Ä–æ–≤–∞–ª–∏–≤–∞—é—Ç—Å—è –≤ —Å–Ω–µ–≥ —Ç–∞–∫ —Å–∏–ª—å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–ª–æ—â–∞–¥—å –±–æ–ª—å—à–µ ‚Üí –¥–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—å—à–µ.",
            "–ï—Å–ª–∏ —Ç–æ–ª–∫–∞—Ç—å —Å–∏–ª—å–Ω–µ–µ, —É—Å–∫–æ—Ä–µ–Ω–∏–µ –±–æ–ª—å—à–µ ‚Äî —Å–∏–ª–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ.",
            "–≠–Ω–µ—Ä–≥–∏—è ‚Äî –∫–∞–∫ –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–π–∫–∏: —á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å."
        ]
    elif subject == "Chemistry":
        examples = [
            "–°–∞—Ö–∞—Ä –±—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç–≤–æ—Ä—è–µ—Ç—Å—è –≤ –≥–æ—Ä—è—á–µ–π –≤–æ–¥–µ ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å.",
            "–ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä ‚Äî –∫–∞–∫ –ø–æ–º–æ—â–Ω–∏–∫: —É—Å–∫–æ—Ä—è–µ—Ç —Ä–µ–∞–∫—Ü–∏—é, –Ω–æ —Å–∞–º –ø–æ—á—Ç–∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è.",
            "–ë–æ–ª—å—à–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è ‚Üí —á–∞—â–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü ‚Üí —Ä–µ–∞–∫—Ü–∏—è –±—ã—Å—Ç—Ä–µ–µ."
        ]
    elif subject == "Biology":
        examples = [
            "–ù–µ–π—Ä–æ–Ω—ã –∫–∞–∫ –ø—Ä–æ–≤–æ–¥–∞: –ø–µ—Ä–µ–¥–∞—é—Ç —Å–∏–≥–Ω–∞–ª—ã.",
            "–ì–µ–Ω –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ø–æ –Ω–µ–π –¥–µ–ª–∞—é—Ç –±–µ–ª–∫–∏.",
            "–ò–º–º—É–Ω–∏—Ç–µ—Ç –∫–∞–∫ –æ—Ö—Ä–∞–Ω–∞: —É–∑–Ω–∞—ë—Ç —á—É–∂–æ–µ –∏ –∑–∞—â–∏—â–∞–µ—Ç."
        ]
    else:
        examples = [
            "–û–±—ä—è—Å–Ω–∏ —ç—Ç–æ –º–ª–∞–¥—à–µ–º—É –±—Ä–∞—Ç—É –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º.",
            "–ü—Ä–∏–¥—É–º–∞–π –ø—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏ (—à–∫–æ–ª–∞/—Å–ø–æ—Ä—Ç/–µ–¥–∞/–∏–≥—Ä—ã).",
            "–ó–∞–º–µ–Ω–∏ —Å–ª–æ–∂–Ω—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ ‚Äî —Å–º—ã—Å–ª –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è."
        ]

    quiz = [
        ("–ü–æ–Ω–∏–º–∞–Ω–∏–µ", "–û–±—ä—è—Å–Ω–∏ –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º, –æ —á—ë–º —Ç–µ–∫—Å—Ç.", "–°—Ä–∞–≤–Ω–∏ —Å Main idea"),
        ("–¢–µ—Ä–º–∏–Ω—ã", "–ù–∞–∑–æ–≤–∏ 1 —Å–ª–æ–∂–Ω—ã–π —Ç–µ—Ä–º–∏–Ω –∏ –æ–±—ä—è—Å–Ω–∏ –µ–≥–æ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.", "–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ Glossary"),
        ("–ü—Ä–∏–º–µ—Ä", "–ü—Ä–∏–≤–µ–¥–∏ 1 –ø—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∏–¥–µ–µ.", "–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ Examples"),
        ("–ü—Ä–æ–≤–µ—Ä–∫–∞", "–ß—Ç–æ –±—ã–ª–æ —Å–∞–º—ã–º –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º?", "–ó–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑—É"),
        ("–ò—Ç–æ–≥", "–ö–∞–∫–∞—è –≥–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å?", "–û–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –≤—ã–≤–æ–¥"),
    ]

    return explanation, glossary, examples, quiz

# ---------------- UI ----------------
st.title("üß† Explain Like I‚Äôm 12")
st.caption("Paste textbook text ‚Üí get simple explanation + examples + mini-quiz (no external API).")

demo_bio = "–ù–µ–π—Ä–æ–Ω ‚Äî —ç—Ç–æ –∫–ª–µ—Ç–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–¥–∞—ë—Ç —Å–∏–≥–Ω–∞–ª—ã –≤ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –°–∏–≥–Ω–∞–ª—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Å–∏–Ω–∞–ø—Å—ã —Å –ø–æ–º–æ—â—å—é —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö –≤–µ—â–µ—Å—Ç–≤. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –º–æ–∑–≥—É —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è–º–∏ –∏ —á—É–≤—Å—Ç–≤–∞–º–∏."
demo_chem = "–°–∫–æ—Ä–æ—Å—Ç—å —Ö–∏–º–∏—á–µ—Å–∫–æ–π —Ä–µ–∞–∫—Ü–∏–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –Ω–∞–ª–∏—á–∏—è –∫–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä–∞. –ü—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —á–∞—Å—Ç–∏—Ü—ã –¥–≤–∏–∂—É—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –∏ —á–∞—â–µ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∞–∫—Ü–∏—è —É—Å–∫–æ—Ä—è–µ—Ç—Å—è."
demo_phys = "–î–∞–≤–ª–µ–Ω–∏–µ ‚Äî —ç—Ç–æ —Å–∏–ª–∞, –¥–µ–π—Å—Ç–≤—É—é—â–∞—è –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É –ø–ª–æ—â–∞–¥–∏. –ï—Å–ª–∏ –ø–ª–æ—â–∞–¥—å –æ–ø–æ—Ä—ã –º–µ–Ω—å—à–µ, –¥–∞–≤–ª–µ–Ω–∏–µ –±–æ–ª—å—à–µ. –ü–æ—ç—Ç–æ–º—É –æ—Å—Ç—Ä—ã–π –Ω–æ–∂ —Ä–µ–∂–µ—Ç –ª—É—á—à–µ, —á–µ–º —Ç—É–ø–æ–π."

c1, c2, c3 = st.columns(3)
if c1.button("Demo: Biology"):
    st.session_state["text"] = demo_bio
if c2.button("Demo: Chemistry"):
    st.session_state["text"] = demo_chem
if c3.button("Demo: Physics"):
    st.session_state["text"] = demo_phys

text = st.text_area("Paste your text here:", value=st.session_state.get("text", ""), height=180)

if st.button("‚ú® Explain"):
    explanation, glossary, examples, quiz = eli12_explain(text)
    if not explanation:
        st.warning("Paste some text first.")
    else:
        st.subheader("1) Simple explanation")
        st.markdown(explanation)

        st.subheader("2) Glossary (hard words ‚Üí simple meaning)")
        if glossary:
            for w, d in glossary:
                st.write(f"**{w}** ‚Äî {d}")
        else:
            st.write("No hard words detected (or text is very short).")

        st.subheader("3) Examples")
        for e in examples:
            st.write("‚Ä¢ " + e)

        st.subheader("4) Mini-quiz (5 questions)")
        show = st.toggle("Show hints", value=False)
        for i, (typ, q, a) in enumerate(quiz, 1):
            st.write(f"**Q{i} ({typ}):** {q}")
            if show:
                st.caption("Hint: " + a)
